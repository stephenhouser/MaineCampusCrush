<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- http://www.emanueleferonato.com/2011/10/07/complete-bejeweled-prototype-made-wiht-jquery/ -->
<html>
<head>
<title>Maine Campus Crush</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<link rel="apple-touch-icon" href="splash.png">
<link rel="apple-touch-startup-image" href="/startup-image.png">
<link rel="image_src" href="splash.png" />

<meta name="format-detection" content="telephone=no">
<script type="application/x-javascript" src="http://code.jquery.com/jquery.min.js"></script>
<script type="application/x-javascript" src="https://cdnjs.cloudflare.com/ajax/libs/howler/1.1.17/howler.min.js"></script>

<script>
/*
var backgroundSound = 0;
document.addEventListener('visibilitychange', function(){
		backgroundSound.pause();
		if (!document.hidden) {
			backgroundSound.play();
		}
	},false);
*/

$(document).ready(function(){
	var clearSound = new Howl({urls: ['clear.wav']});
	var dropSound = new Howl({urls: ['drop.wav']});
	var selectSound = new Howl({urls: ['select.wav']});
	var errorSound = new Howl({urls: ['error.wav']});
	/*
	backgroundSound = new Howl({
			urls: ['background.mp3'],
			autoplay: true,
			loop: true,
			volume: 0.25
		}).play();
	*/

	var cols = 6;
	var rows = 8;
  	var jewelTypes = 8;

	var gamePos = $('#gamefield').position();
	var topOffset = gamePos.top;		// 10
	var leftOffset = 7;					// 10

	var preferredCellSize = 60;
	if ($(window).width() > (preferredCellSize * cols)) {
		leftOffset = ($(window).width() - (preferredCellSize * cols)) / 2;
	}

	var cellSize = Math.floor(Math.min(preferredCellSize, (($(window).width() - (leftOffset * 2)) / cols)));

	//rows = Math.floor(($(window).height() - topOffset) / cellSize)

	var gemSize = Math.floor(cellSize * 0.8);
	var markerSize = gemSize + 2;

  	$("#marker").css({
  		"width":markerSize+"px",
  		"height":markerSize+"px",
  		"border-radius":"5px",
  		"border":"5px solid white",
  		"position":"absolute"
  	}).hide();
	var selectedRow=-1
  	var selectedCol=-1
  	var posX;
  	var posY;
  	var jewels=new Array();
  	var movingItems=0;
  	var gameState="pick";

  	var bgColors=new Array(
  		"rgba(0,56,147,0.6)",
  		"#75B2DD",
  		"#60C659",
  		"maroon",
  		"gold",
  		"gold",
  		"green",
  		"white");
  	var bgImages=new Array(
  		"url(usm.png)",
  		"url(umaine.png)",
  		"url(uma.png)",
  		"url(umf.png)",
  		"url(umpi.png)",
  		"url(umfk.png)",
  		"url(umm.png)",
  		"url(ums.png)"
  	);

  	for(i=0; i<rows; i++){
     	jewels[i] = new Array();
     	for(j=0; j<cols; j++){
          	jewels[i][j]=-1;
     	}
  	}

	for(i=0; i<rows; i++){
		for(j=0; j<cols; j++){
			do{
				jewels[i][j] = Math.floor(Math.random()*jewelTypes);
			} while(isStreak(i,j));

			$("#gamefield").append('<div class = "gem" id = "gem_'+i+'_'+j+'"></div>');
			$("#gem_"+i+"_"+j).css({
				"top":(i*cellSize)+topOffset+"px",
				"left":(j*cellSize)+leftOffset+"px",
				"width":gemSize+"px",
				"height":gemSize+"px",
				"position":"absolute",
				"border":"2px solid white",
				"border-radius": "5px",
				"cursor":"pointer",
				"background-size":gemSize+"px",
				"background-image":bgImages[jewels[i][j]],
				"background-color":bgColors[jewels[i][j]]
			});
		}
	}

	$(document).on("click",".gem", function(){
		if(gameState=="pick"){
			posY=$(this).position().top;
			posX=$(this).position().left;
			$("#marker").show();
			$("#marker").css("top",posY-5).css("left",posX-5);
			if(selectedRow==-1){
				selectSound.play();
				selectedRow=(posY-topOffset)/cellSize;
				selectedCol=(posX-leftOffset)/cellSize;
			}
			else{
				posY=(posY-topOffset)/cellSize;
				posX=(posX-leftOffset)/cellSize;
				if((Math.abs(selectedRow-posY)==1 && selectedCol==posX)||(Math.abs(selectedCol-posX)==1 && selectedRow==posY)){
					$("#marker").hide();
					gameState="switch";
					gemSwitch();
				}
				else{
					selectedRow=posY;
					selectedCol=posX;
				}
			}
		}
	});

	function checkMoving(){
		movingItems--;
    		if(movingItems==0){
    			switch(gameState){
    				case "revert":
    				case "switch":
                  		if(!isStreak(selectedRow,selectedCol) && !isStreak(posY,posX)){
							if(gameState!="revert"){
								errorSound.play();
								gameState="revert";
								gemSwitch();
							}
							else{
								gameState="pick";
								selectedRow=-1;
							}
                    	}
					else{
						gameState="remove";
                    		if(isStreak(selectedRow,selectedCol)){
                    			removeGems(selectedRow,selectedCol);
						}
                    		if(isStreak(posY,posX)){
                    			removeGems(posY,posX);
						}
						gemFade();
					}
					break;
				case "remove":
					checkFalling();
					break;
				case "refill":
					placeNewGems();
					break;
			}
		}
	}

	function placeNewGems(){
		var gemsPlaced = 0;
		for(i=0;i<cols;i++){
			if(jewels[0][i]==-1){
				jewels[0][i]=Math.floor(Math.random()*jewelTypes);
          		$("#gamefield").append('<div class = "gem" id = "gem_0_'+i+'"></div>');
          		$("#gem_0_"+i).css({
          			"top":topOffset+"px",
          			"left":(i*cellSize)+leftOffset+"px",
          			"width":gemSize+"px",
          			"height":gemSize+"px",
          			"position":"absolute",
					"border":"2px solid white",
					"border-radius": "5px",
          			"cursor":"pointer",
					"background-size":gemSize+"px",
          			"background-image":bgImages[jewels[0][i]],
          			"background-color":bgColors[jewels[0][i]]
          		});

          		gemsPlaced++;
				dropSound.play();
			}
		}

		if(gemsPlaced){
			gameState="remove";
			checkFalling();
		}
		else{
			var combo=0
			for(i=0;i<rows;i++){
      			for(j=0;j<cols;j++){
      				if(j<=(cols-3) && jewels[i][j]==jewels[i][j+1] && jewels[i][j]==jewels[i][j+2]){
						combo++;
						removeGems(i,j);
					}
					if(i<=(rows-3) && jewels[i][j]==jewels[i+1][j] && jewels[i][j]==jewels[i+2][j]){
						combo++;
						removeGems(i,j);
					}
				}
			}
			if(combo>0){
				gameState="remove";
				gemFade();
			}
			else{
				gameState="pick";
				selectedRow=-1;
			}
		}
	}

	function checkFalling(){
		var fellDown=0;
		for(j=0;j<cols;j++){
			for(i=(rows-1);i>0;i--){
				if(jewels[i][j]==-1 && jewels[i-1][j]>=0){
					$("#gem_"+(i-1)+"_"+j).addClass("fall").attr("id","gem_"+i+"_"+j);
					jewels[i][j]=jewels[i-1][j];
					jewels[i-1][j]=-1;
					fellDown++;
				}
			}
		}

		$.each($(".fall"),function(){
			movingItems++;
			$(this).animate({
				top: "+=" + cellSize
				},{
				duration: 150,
				complete: function(){
					$(this).removeClass("fall");
					checkMoving();
				}
			});
		});

		if(fellDown==0){
			gameState="refill";
			movingItems=1;
			checkMoving();
		}
	}

	function gemFade(){
		$.each($(".remove"),function(){
			clearSound.play();

			movingItems++;
			$(this).animate({
				opacity:0
				},{
				duration: 150,
				complete: function(){
					$(this).remove();
					checkMoving();

					// Update score
					i = parseInt($("#score").text());
					$("#score").text((i+10));
				}
			});
		});
	}

	function gemSwitch(){
		var yOffset=selectedRow-posY;
		var xOffset=selectedCol-posX;
		$("#gem_"+selectedRow+"_"+selectedCol).addClass("switch").attr("dir","-1");
		$("#gem_"+posY+"_"+posX).addClass("switch").attr("dir","1");
		$.each($(".switch"),function(){
			movingItems++;
			$(this).animate({
				left: "+="+xOffset*cellSize*$(this).attr("dir"),
				top: "+="+yOffset*cellSize*$(this).attr("dir")
				},{
				duration: 150,
				complete: function(){
					checkMoving();
				}
			}).removeClass("switch")
		});
		$("#gem_"+selectedRow+"_"+selectedCol).attr("id","temp");
		$("#gem_"+posY+"_"+posX).attr("id","gem_"+selectedRow+"_"+selectedCol);
		$("#temp").attr("id","gem_"+posY+"_"+posX);
		var temp=jewels[selectedRow][selectedCol];
		jewels[selectedRow][selectedCol]=jewels[posY][posX];
		jewels[posY][posX]=temp;
	}

	function removeGems(row,col){
		var gemValue = jewels[row][col];
		var tmp = row;
		$("#gem_"+row+"_"+col).addClass("remove");

		if(isVerticalStreak(row,col)){
			while(tmp>0 && jewels[tmp-1][col]==gemValue){
				$("#gem_"+(tmp-1)+"_"+col).addClass("remove");
				jewels[tmp-1][col]=-1;
				tmp--;
			}

			tmp=row;
			while(tmp<(rows-1) && jewels[tmp+1][col]==gemValue){
				$("#gem_"+(tmp+1)+"_"+col).addClass("remove");
				jewels[tmp+1][col]=-1;
				tmp++;
			}
		}

		if(isHorizontalStreak(row,col)){
			tmp = col;
			while(tmp>0 && jewels[row][tmp-1]==gemValue){
				$("#gem_"+row+"_"+(tmp-1)).addClass("remove");
				jewels[row][tmp-1]=-1;
				tmp--;
			}

			tmp=col;
			while(tmp<(cols-1) && jewels[row][tmp+1]==gemValue){
				$("#gem_"+row+"_"+(tmp+1)).addClass("remove");
				jewels[row][tmp+1]=-1;
				tmp++;
			}
		}

		jewels[row][col]=-1;
	}

	function isVerticalStreak(row,col){
		var gemValue=jewels[row][col];
		var streak=0;
		var tmp=row;
		while(tmp>0 && jewels[tmp-1][col]==gemValue){
			streak++;
			tmp--;
		}
		tmp=row;
		while(tmp<(rows-1) && jewels[tmp+1][col]==gemValue){
			streak++;
			tmp++;
		}
		return streak>1
	}

	function isHorizontalStreak(row,col){
		var gemValue=jewels[row][col];
		var streak=0;
		var tmp=col
		while(tmp>0 && jewels[row][tmp-1]==gemValue){
			streak++;
			tmp--;
		}
		tmp=col;
		while(tmp<(cols-1) && jewels[row][tmp+1]==gemValue){
			streak++;
			tmp++;
		}
		return streak>1
	}

	function isStreak(row,col){
		return isVerticalStreak(row,col)||isHorizontalStreak(row,col);
	}
});

function hideAbout() {
	$("#about").hide();
}

function showAbout() {
	$("#about").show();
}
</script>
<style>
* {
	margin: 0;
}

html, body {
	background-color: black;
}

#header {
	margin-top: 2px;
	width: 100%;
	height: 50px;
	color: white;
}

a {
	color: white;
}

#about-button {
	position: absolute;
	top: 5px;
	left: 10px;
	font-size: large;
}

#replay-button {
	position: absolute;
	top: 5px;
	right: 10px;
	font-size: large;
}

#score {
	text-align: center;
	font-size: xx-large;
}

#gamefield {
	width: 100%;
}

#splash {
	display: none;
}

#about {
	display: none;
	position: absolute;
	background-color: rgba(128, 128, 128, 0.95);
	color: white;
	top: 5%;
	left: 5%;
	height: 90%;
	width: 90%;
	z-index: 10;
}

</style>
</head>
<body>
	<div id="about">
		<h2>Maine Campus Crush</h2>
		<p>Score points by swapping two adjacent campus mascots to make chains
		of three or more of the same campus mascot. Swap mascots by
		clicking or tapping on them.</p>
		<br/>
		<p>The campuses and mascots of the University of Maine System:
		<ul>
			<li>UMaine - Black Bears</li>
			<li>USM - Huskies</li>
			<li>UMA - Moose</li>
			<li>UMF - Beavers</li>
			<li>UMM - Clippers</li>
			<li>UMFK - Bengals</li>
			<li>UMPI - Owls</li>
			<li>UMS - "Blue Ball"</li>
		</ul>
		</p>
		<br/>
		<p>The base code was adapted from
		<a href="http://www.emanueleferonato.com/2011/10/07/complete-bejeweled-prototype-made-wiht-jquery/">Emanuele Feronato</a>'s
		blog article on a JavaScript Bejeweled Game.</a> The mascot images were used from each
		campuses website -- taking the one that best matched the style of the game.</p>

		<br/>
		<p>-- <a href="http://about.me/stephenhouser">Stephen Houser</a></p>

		<button id="done" type="button" onClick="hideAbout();">Ok</button>
	</div>

	<div id="splash"><img src="splash.png"/>
	</div>

	<div id="header">
		<a href="#" id="about-button" type="button" onClick="showAbout();">About</a>
		<div id="score">0</div>
		<a href="#" id="replay-button" type="button" onClick="location.reload();">Replay</a>
	</div>

	<div id="gamefield">
	</div>

	<div id="marker">
	</div>
</body>
</html>
