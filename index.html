<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- http://www.emanueleferonato.com/2011/10/07/complete-bejeweled-prototype-made-wiht-jquery/ -->
<html>
<head>
<title>Maine Campus Crush</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<script src = "http://code.jquery.com/jquery.min.js"></script>
<script>

$(document).ready(function(){
	// iPhone 5s
	var cols = 6;
	var rows = 8;

	var gamePos = $('#gamefield').position();
	var topOffset = gamePos.top;		// 10
	var leftOffset = 5;					// 10

	var gameFieldWidth = cols * cellSize;
	if ($(window).width() > 360) {
		leftOffset = ($(window).width() - 360) / 2;
	}

	var cellSize = Math.floor(Math.min(60, (($(window).width() - (leftOffset * 2)) / cols)));
	var gemSize = Math.floor(cellSize * 0.8);
	//var gemSize = cellSize - 8;
	var markerSize = gemSize + 2;

  	$("#marker").css({
  		"width":markerSize+"px",
  		"height":markerSize+"px",
  		"border-radius":"5px",
  		"border":"5px solid white",
  		"position":"absolute"
  	}).hide();
	var selectedRow=-1
  	var selectedCol=-1
  	var posX;
  	var posY;
  	var jewels=new Array();
  	var movingItems=0;
  	var gameState="pick";
  	//var bgColors=new Array("#003893","#75B2DD","#60C659","maroon","gold","gold","green","white");
  	var bgColors=new Array("rgba(0,56,147,0.6)","#75B2DD","#60C659","maroon","gold","gold","green","white");
  	var bgImages=new Array("url(usm.png)", "url(umaine.png)", "url(uma.png)", "url(umf.png)", "url(umpi.png)", "url(umfk.png)", "url(umm.png)", "url(ums.png)");

  	for(i=0; i<rows; i++){
     	jewels[i] = new Array();
     	for(j=0; j<cols; j++){
          	jewels[i][j]=-1;
     	}
  	}

	for(i=0; i<rows; i++){
		for(j=0; j<cols; j++){
			do{
				jewels[i][j] = Math.floor(Math.random()*8);
			} while(isStreak(i,j));

			$("#gamefield").append('<div class = "gem" id = "gem_'+i+'_'+j+'"></div>');
			$("#gem_"+i+"_"+j).css({
				"top":(i*cellSize)+topOffset+"px",
				"left":(j*cellSize)+leftOffset+"px",
				"width":gemSize+"px",
				"height":gemSize+"px",
				"position":"absolute",
				"border":"2px solid white",
				"border-radius": "5px",
				"cursor":"pointer",
				"background-size":gemSize+"px",
				"background-image":bgImages[jewels[i][j]],
				"background-color":bgColors[jewels[i][j]]
			});
		}
	}
	$(document).on("click",".gem", function(){
		if(gameState=="pick"){
			posY=$(this).position().top;
			posX=$(this).position().left;
			$("#marker").show();
			$("#marker").css("top",posY-5).css("left",posX-5);
			if(selectedRow==-1){
				selectedRow=(posY-topOffset)/cellSize;
				selectedCol=(posX-leftOffset)/cellSize;
			}
			else{
				posY=(posY-topOffset)/cellSize;
				posX=(posX-leftOffset)/cellSize;
				if((Math.abs(selectedRow-posY)==1 && selectedCol==posX)||(Math.abs(selectedCol-posX)==1 && selectedRow==posY)){
					$("#marker").hide();
					gameState="switch";
					gemSwitch();
				}
				else{
					selectedRow=posY;
					selectedCol=posX;
				}
			}
		}
	});

	function checkMoving(){
		movingItems--;
    		if(movingItems==0){
    			switch(gameState){
    				case "revert":
    				case "switch":
                  		if(!isStreak(selectedRow,selectedCol) && !isStreak(posY,posX)){
               			if(gameState!="revert"){
							gameState="revert";
               				gemSwitch();
               			}
               			else{
							gameState="pick";
							selectedRow=-1;
						}
                    	}
					else{
						gameState="remove";
                    		if(isStreak(selectedRow,selectedCol)){
                    			removeGems(selectedRow,selectedCol);
						}
                    		if(isStreak(posY,posX)){
                    			removeGems(posY,posX);
						}
						gemFade();
					}
					break;
				case "remove":
					checkFalling();
					break;
				case "refill":
					placeNewGems();
					break;
			}
		}
	}

	function placeNewGems(){
		var gemsPlaced = 0;
		for(i=0;i<cols;i++){
			if(jewels[0][i]==-1){
				jewels[0][i]=Math.floor(Math.random()*8);
          		$("#gamefield").append('<div class = "gem" id = "gem_0_'+i+'"></div>');
          		$("#gem_0_"+i).css({
          			"top":topOffset+"px",
          			"left":(i*cellSize)+leftOffset+"px",
          			"width":gemSize+"px",
          			"height":gemSize+"px",
          			"position":"absolute",
					"border":"2px solid white",
					"border-radius": "5px",
          			"cursor":"pointer",
					"background-size":gemSize+"px",
          			"background-image":bgImages[jewels[0][i]],
          			"background-color":bgColors[jewels[0][i]]
          		});

          		gemsPlaced++;
			}
		}
		if(gemsPlaced){
			gameState="remove";
			checkFalling();
		}
		else{
			var combo=0
			for(i=0;i<rows;i++){
      			for(j=0;j<cols;j++){
      				if(j<=(cols-3) && jewels[i][j]==jewels[i][j+1] && jewels[i][j]==jewels[i][j+2]){
						combo++;
						removeGems(i,j);
					}
					if(i<=(rows-3) && jewels[i][j]==jewels[i+1][j] && jewels[i][j]==jewels[i+2][j]){
						combo++;
						removeGems(i,j);
					}
				}
			}
			if(combo>0){
				gameState="remove";
				gemFade();
			}
			else{
				gameState="pick";
				selectedRow=-1;
			}
		}
	}

	function checkFalling(){
		var fellDown=0;
		for(j=0;j<cols;j++){
			for(i=(rows-1);i>0;i--){
				if(jewels[i][j]==-1 && jewels[i-1][j]>=0){
					$("#gem_"+(i-1)+"_"+j).addClass("fall").attr("id","gem_"+i+"_"+j);
					jewels[i][j]=jewels[i-1][j];
					jewels[i-1][j]=-1;
					fellDown++;
				}
			}
		}
		$.each($(".fall"),function(){
			movingItems++;
			$(this).animate({
				top: "+=" + cellSize
				},{
				duration: 150,
				complete: function(){
					$(this).removeClass("fall");
					checkMoving();
				}
			});
		});
		if(fellDown==0){
			gameState="refill";
			movingItems=1;
			checkMoving();
		}
	}

	function gemFade(){
		$.each($(".remove"),function(){
			movingItems++;
			$(this).animate({
				opacity:0
				},{
				duration: 150,
				complete: function(){
					$(this).remove();
					checkMoving();

					// Update score
					i = parseInt($("#score").text());
					$("#score").text((i+10));
				}
			});
		});
	}

	function gemSwitch(){
		var yOffset=selectedRow-posY;
		var xOffset=selectedCol-posX;
		$("#gem_"+selectedRow+"_"+selectedCol).addClass("switch").attr("dir","-1");
		$("#gem_"+posY+"_"+posX).addClass("switch").attr("dir","1");
		$.each($(".switch"),function(){
			movingItems++;
			$(this).animate({
				left: "+="+xOffset*cellSize*$(this).attr("dir"),
				top: "+="+yOffset*cellSize*$(this).attr("dir")
				},{
				duration: 150,
				complete: function(){
					checkMoving();
				}
			}).removeClass("switch")
		});
		$("#gem_"+selectedRow+"_"+selectedCol).attr("id","temp");
		$("#gem_"+posY+"_"+posX).attr("id","gem_"+selectedRow+"_"+selectedCol);
		$("#temp").attr("id","gem_"+posY+"_"+posX);
		var temp=jewels[selectedRow][selectedCol];
		jewels[selectedRow][selectedCol]=jewels[posY][posX];
		jewels[posY][posX]=temp;
	}

	function removeGems(row,col){
		var gemValue = jewels[row][col];
		var tmp = row;
		$("#gem_"+row+"_"+col).addClass("remove");
		if(isVerticalStreak(row,col)){
			while(tmp>0 && jewels[tmp-1][col]==gemValue){
				$("#gem_"+(tmp-1)+"_"+col).addClass("remove");
				jewels[tmp-1][col]=-1;
				tmp--;
			}
			tmp=row;
			while(tmp<(rows-1) && jewels[tmp+1][col]==gemValue){
				$("#gem_"+(tmp+1)+"_"+col).addClass("remove");
				jewels[tmp+1][col]=-1;
				tmp++;
			}
		}
		if(isHorizontalStreak(row,col)){
			tmp = col;
			while(tmp>0 && jewels[row][tmp-1]==gemValue){
				$("#gem_"+row+"_"+(tmp-1)).addClass("remove");
				jewels[row][tmp-1]=-1;
				tmp--;
			}
			tmp=col;
			while(tmp<(cols-1) && jewels[row][tmp+1]==gemValue){
				$("#gem_"+row+"_"+(tmp+1)).addClass("remove");
				jewels[row][tmp+1]=-1;
				tmp++;
			}
		}
		jewels[row][col]=-1;
	}

	function isVerticalStreak(row,col){
		var gemValue=jewels[row][col];
		var streak=0;
		var tmp=row;
		while(tmp>0 && jewels[tmp-1][col]==gemValue){
			streak++;
			tmp--;
		}
		tmp=row;
		while(tmp<(rows-1) && jewels[tmp+1][col]==gemValue){
			streak++;
			tmp++;
		}
		return streak>1
	}

	function isHorizontalStreak(row,col){
		var gemValue=jewels[row][col];
		var streak=0;
		var tmp=col
		while(tmp>0 && jewels[row][tmp-1]==gemValue){
			streak++;
			tmp--;
		}
		tmp=col;
		while(tmp<(cols-1) && jewels[row][tmp+1]==gemValue){
			streak++;
			tmp++;
		}
		return streak>1
	}

	function isStreak(row,col){
		return isVerticalStreak(row,col)||isHorizontalStreak(row,col);
	}
});
</script>
<style>
* {
	margin: 0;
}

html, body {
	background-color: black;
}

#header {
	margin-top: 2px;
	width: 100%;
	height: 50px;
	color: white;
}

#header a {
	color: white;
}

#about {
	position: absolute;
	top: 5px;
	left: 10px;
	font-size: large;
}

#replay {
	position: absolute;
	top: 5px;
	right: 10px;
	font-size: large;
}

#score {
	text-align: center;
	font-size: x-large;
}

#gamefield {
	width: 100%;
}

</style>
</head>
<body>
<div id="header">
	<a href="http://about.me/stephenhouser" id="about" type="button";">About</a>
	<div id="score">0</div>
	<a href="#" id="replay" type="button" onClick="location.reload();">Replay</a>
</div>
<div id="gamefield">
</div>
<div id="footer">
</div>
<div id="marker">
</div>
</body>
</html>
